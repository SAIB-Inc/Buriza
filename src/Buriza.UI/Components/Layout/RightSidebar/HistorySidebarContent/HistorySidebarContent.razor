@using Buriza.UI.Components.Common
@using Buriza.UI.Components.Controls
@using Buriza.UI.Resources
@using Buriza.UI.Data.Dummy
@using Buriza.Data.Models.Common
@using Buriza.Data.Models.Enums

@namespace Buriza.UI.Components.Layout

<div class="bg-[var(--mud-palette-drawer-background)] !rounded-[16px] !pt-4 !pb-0 h-full flex flex-col">
    <div class="w-full flex items-center justify-between !px-4">
        <div class="flex items-center !gap-3 h-[38px]">
            <div>
                <MudText Class="!font-medium !text-[22px]">
                    History
                </MudText>
            </div>
        </div>
        <div>
            <MudIconButton
                Icon="@BurizaIcons.FilterSymbolIcon"
                Class="shadow-[var(--mud-elevation-1)]! [&_.mud-icon-root]:!text-[var(--mud-palette-text-primary)] [&_.mud-icon-root]:!text-[18px] !p-0 !bg-[var(--mud-palette-overlay-light)] !w-9 !h-9"
            />
        </div>
    </div>
    <div class="relative flex-1">
        <div class="w-full !space-y-6 !mt-4 !px-4 !pb-4 overflow-y-auto max-h-[calc(100vh-196px)]">
            @foreach (KeyValuePair<string, List<TransactionHistory>> dateGroup in TransactionsByDate)
            {
                <div>
                    <div class="w-full !mb-3">
                        <MudText Class="!font-medium !text-sm">
                            @dateGroup.Key
                        </MudText>
                    </div>
                    <div>
                        @foreach (TransactionHistory transaction in dateGroup.Value)
                        {
                            <div class="@($"w-full bg-[var(--mud-palette-dark-darken)] !py-3 !px-3 border-l-[2px]! {GetBorderColorClass(transaction.Type)}")">
                                <div class="grid items-center gap-2 grid-cols-[auto_1fr_auto]">
                                    @* Column 1: Transaction Hash with Date *@
                                    <div class="w-max">
                                        <div class="flex items-center !gap-1">
                                            <MudText Class="!text-sm !text-[var(--mud-palette-text-secondary)]">
                                                @TruncateHash(transaction.TransactionId)
                                            </MudText>
                                            <MudIconButton
                                                Icon="@BurizaIcons.CopySymbolIcon"
                                                Class="!p-0 !min-w-0 [&_.mud-icon-root]:!text-base [&_.mud-icon-root]:!text-[var(--mud-palette-text-secondary)]"
                                            />
                                        </div>
                                        <MudText Class="!text-xs !text-[var(--mud-palette-text-secondary)]">
                                            @transaction.Timestamp.ToString("HH:mm")
                                        </MudText>
                                    </div>
                                    @* Column 2: Stacked Asset Images *@
                                    <div class="flex items-center">
                                        @{
                                            var displayedAssets = transaction.Assets.Take(3).ToList();
                                            var remainingCount = transaction.Assets.Count - 4;
                                        }
                                        @foreach (var (asset, index) in displayedAssets.Select((a, i) => (a, i)))
                                        {
                                            <div class="@($"w-7 h-7 rounded-full overflow-hidden border-2 border-[var(--mud-palette-dark-darken)] {(index > 0 ? "-ml-2!" : "")}")" style="z-index: @(displayedAssets.Count + 1 - index)">
                                                <MudImage
                                                    Alt="@asset.AssetName"
                                                    Src="@asset.AssetIcon"
                                                    Class="w-full h-full object-cover"
                                                />
                                            </div>
                                        }
                                        @if (remainingCount > 0)
                                        {
                                            <div class="w-7 h-7 rounded-full border-2 border-[var(--mud-palette-dark-darken)] -ml-2! bg-[var(--mud-palette-action-default)] flex items-center justify-center" style="z-index: 0">
                                                <MudText Class="!text-[10px] !text-[var(--mud-palette-text-secondary)] !font-medium">
                                                    +@remainingCount
                                                </MudText>
                                            </div>
                                        }
                                    </div>
                                    @* Column 3: Value *@
                                    <div class="text-right">
                                        <MudText Class="@($"!text-sm !font-semibold {GetAmountColorClass(transaction.Assets.Sum(a => a.Amount))}")">
                                            @GetAmountDisplay(transaction.Assets.Sum(a => a.Amount), transaction.Type)
                                        </MudText>
                                        <MudText Class="!text-xs !text-[var(--mud-palette-text-secondary)]">
                                            â‰ˆ $@transaction.Assets.Sum(a => a.UsdValue).ToString("F2")
                                        </MudText>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
        <div class="absolute bottom-0 left-0 right-0 h-16 bg-gradient-to-t from-[var(--mud-palette-drawer-background)] to-transparent pointer-events-none rounded-b-[16px]"></div>
    </div>
</div>
